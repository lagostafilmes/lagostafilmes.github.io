<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Lagosta Filmes</title>

<style>
:root {
  --bg-blue: #A5C7F9;
  --line-dark: #000;
  --line-mid: rgba(0,0,0,0.4);
  --box-bg: #ffffff;
  --fm-head: #7a0000;
  --fm-green: #00e060;
  --fm-black: #111;
  --mono: "Courier New", monospace;
  --bodyfont: "Comic Sans MS", "Trebuchet MS", Arial, sans-serif;
  --serif: "Times New Roman", Times, serif;
}

/* corpo liso com fade-in */
body {
  margin: 0;
  min-height: 100vh;
  background: var(--bg-blue);
  color: #000;
  font-family: var(--bodyfont);
  display: flex;
  opacity: 0;
  animation: boot 0.6s ease-out forwards;
}

@keyframes boot {
  0%   { opacity: 0; filter: brightness(1.8) contrast(1.4) blur(2px); }
  60%  { opacity: 1; filter: brightness(1.2) contrast(1.1) blur(0.5px); }
  100% { opacity: 1; filter: none; }
}

/* layout geral */
main {
  max-width: 720px;
  width: 100%;
  margin: auto;
  padding: 16px;
  display: grid;
  grid-template-rows: auto auto auto;
  row-gap: 20px;
  box-sizing: border-box;
}

/* topo / pôster */
header {
  text-align: center;
}
header .marca img {
  max-width: 180px;
  height: auto;
  image-rendering: pixelated;
  margin-bottom: 12px;
}
.poster-wrap {
  background: var(--box-bg);
  border: 1px solid var(--line-dark);
  box-shadow: 2px 2px 0 var(--line-mid);
  padding: 8px;
}
.poster-wrap img {
  width: 100%;
  display: block;
  border: 1px solid var(--line-dark);
}

/* bloco lagosta fm */
.fm-block {
  background: var(--box-bg);
  border: 1px solid var(--line-dark);
  box-shadow: 2px 2px 0 var(--line-mid);
  padding: 12px;
  display: grid;
  row-gap: 16px;
  font-size: 14px;
}

/* header da rádio */
.fm-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  flex-wrap: wrap;
}
.fm-title {
  font-size: 16px;
  font-weight: bold;
  color: var(--fm-head);
  letter-spacing: 0.03em;
}
.fm-status {
  font-family: var(--mono);
  font-size: 11px;
  background: #fff4f4;
  border: 1px solid var(--fm-head);
  color: var(--fm-head);
  padding: 2px 4px;
  border-radius: 2px;
  text-transform: uppercase;
  line-height: 1;
}

/* player */
.player-box {
  border: 1px solid var(--line-dark);
  background: #f2f2f2;
  padding: 10px;
  display: grid;
  row-gap: 10px;
  font-family: var(--mono);
  font-size: 12px;
  color: #000;
}

/* título do episódio e label FM */
.player-row-top {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
}
.player-left { font-weight: bold; }
.player-right { color: var(--fm-head); font-weight: bold; }

/* controles + barra */
.player-controls {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  flex-wrap: nowrap;
  width: 100%;
}

/* botão play/pause */
.play-btn {
  background: var(--fm-head);
  color: #fff;
  border: 0;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: bold;
  padding: 6px 12px;
  cursor: url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32">\
<path fill="white" stroke="black" stroke-width="1" d="M4 2 L4 22 L9 17 L12 28 L15 27 L12 16 L18 16 Z"/>\
</svg>') 4 2, pointer;
  border-radius: 2px;
  line-height: 1;
}

/* barra de progresso + marcadores */
.progress-area {
  flex: 1;
  min-width: 0;
  display: grid;
  row-gap: 6px;
  width: 100%;
}

/* a linha vermelha */
.progress-wrapper {
  position: relative;
  width: 100%;
}

/* fundo vermelho */
.progress-bar-bg {
  width: 100%;
  height: 6px;
  background: #d00;
  border: 1px solid var(--line-dark);
  border-radius: 2px;
  overflow: hidden;
  position: relative;
}

/* preenchimento branco */
.progress-bar-fill {
  background: #fff;
  width: 0%;
  height: 100%;
}

/* marcadores de comentários */
.comment-marker {
  position: absolute;
  top: -3px;
  width: 6px;
  height: 12px;
  background: var(--fm-green);
  border: 1px solid #000;
  border-radius: 1px;
  cursor: pointer;
  box-sizing: border-box;
}

/* balão que aparece quando toca num marcador */
.marker-bubble {
  position: absolute;
  left: 0;
  bottom: 16px;
  background: #000;
  color: var(--fm-green);
  font-family: var(--mono);
  font-size: 10px;
  line-height: 1.3;
  padding: 4px 6px;
  border: 1px solid var(--fm-green);
  white-space: nowrap;
  display: none;
  pointer-events: none;
  max-width: 220px;
  overflow: hidden;
  text-overflow: ellipsis;
  z-index: 10;
}

.time-row {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  line-height: 1;
  width: 100%;
}

audio {
  display: none;
}

/* chat */
.chat-box {
  border: 1px solid var(--line-dark);
  background: var(--fm-black);
  color: var(--fm-green);
  font-family: var(--mono);
  font-size: 11px;
  display: grid;
  row-gap: 8px;
  padding: 10px;
  border-radius: 2px;
}

/* header chat */
.chat-head {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  flex-wrap: nowrap;
}
.chat-head-left {
  font-weight: bold;
  color: var(--fm-green);
}
.chat-head-right {
  background: #d00;
  color: #fff;
  font-weight: bold;
  font-size: 10px;
  padding: 1px 4px;
  border-radius: 2px;
  line-height: 1;
  text-transform: uppercase;
}

/* log do chat */
.chat-log {
  max-height: 90px;
  overflow-y: auto;
  border: 1px solid var(--fm-green);
  padding: 6px;
  background: #000;
  line-height: 1.4;
  scrollbar-width: thin;
}
.chat-line {
  white-space: nowrap;
  margin-bottom: 4px;
}
.chat-line .hora {
  color: #888;
}
.chat-line .nick {
  color: var(--fm-green);
  font-weight: bold;
}
.chat-line .at-time {
  color: #888;
  font-size: 10px;
  margin-left: 4px;
}

/* input + botão enviar */
.chat-input-row {
  display: flex;
  gap: 6px;
  flex-wrap: nowrap;
}
.chat-input-row input {
  flex: 1;
  background: #000;
  color: var(--fm-green);
  border: 1px solid var(--fm-green);
  font-family: var(--mono);
  font-size: 11px;
  padding: 6px;
  border-radius: 2px;
}
.chat-input-row button {
  background: var(--fm-green);
  color: #000;
  border: 0;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: bold;
  padding: 6px 8px;
  border-radius: 2px;
  line-height: 1;
  cursor: url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32">\
<path fill="white" stroke="black" stroke-width="1" d="M4 2 L4 22 L9 17 L12 28 L15 27 L12 16 L18 16 Z"/>\
</svg>') 4 2, pointer;
}

/* contato */
footer {
  text-align: center;
  font-family: var(--serif);
  font-size: 13px;
  color: #000;
  background: var(--box-bg);
  border: 1px solid var(--line-dark);
  box-shadow: 2px 2px 0 var(--line-mid);
  padding: 10px;
}
footer b {
  font-family: var(--mono);
  font-size: 12px;
}

/* responsivo */
@media (max-width: 480px) {
  main { padding: 12px; row-gap: 16px; }
  .chat-log { max-height: 80px; }
}
</style>
</head>

<body>
<main>
  <!-- topo / pôster -->
  <header>
    <div class="marca">
      <img src="logo-lagosta-filmes.png" alt="LAGOSTA FILMES">
    </div>
    <div class="poster-wrap">
      <img src="poster-fortown.png" alt="EM BREVE">
    </div>
  </header>

  <!-- lagosta fm -->
  <section class="fm-block">
    <div class="fm-header">
      <div class="fm-title">LAGOSTA FM</div>
      <div class="fm-status">ON AIR</div>
    </div>

    <!-- player -->
    <div class="player-box">
      <div class="player-row-top">
        <div class="player-left">EP PILOTO</div>
        <div class="player-right">LAGOSTA FM</div>
      </div>

      <div class="player-controls">
        <button id="playBtn" class="play-btn">PLAY</button>

        <div class="progress-area">
          <div class="progress-wrapper">
            <div class="progress-bar-bg" id="progressBar">
              <div class="progress-bar-fill" id="progressFill"></div>
              <!-- marcadores vão ser inseridos aqui via JS -->
              <div class="marker-bubble" id="markerBubble"></div>
            </div>
          </div>

          <div class="time-row">
            <div id="currentTime">00:00</div>
            <div id="totalTime">--:--</div>
          </div>
        </div>
      </div>

      <!-- áudio real -->
      <audio id="audioPlayer">
        <source src="ep-piloto.mp3" type="audio/mpeg">
      </audio>
    </div>

    <!-- chat -->
    <div class="chat-box">
      <div class="chat-head">
        <div class="chat-head-left">chat do estúdio / lagosta fm</div>
        <div class="chat-head-right">live</div>
      </div>

      <div id="chatLog" class="chat-log">
        <!-- mensagens aparecem aqui -->
      </div>

      <div class="chat-input-row">
        <input id="chatInput" type="text" maxlength="180" placeholder="digite sua mensagem...">
        <button id="sendBtn">ENVIAR</button>
      </div>
    </div>
  </section>

  <!-- contato -->
  <footer>
    <div><b>oi@lagostafilmes.com</b></div>
    <div>insta: <b>@lagosta.filmes</b></div>
  </footer>
</main>

<script>
/* =========================================================
   PLAYER / TIMECODE
   ========================================================= */
const audioEl = document.getElementById("audioPlayer");
const playBtn = document.getElementById("playBtn");
const progressFill = document.getElementById("progressFill");
const currentTimeEl = document.getElementById("currentTime");
const totalTimeEl = document.getElementById("totalTime");
const progressBar = document.getElementById("progressBar");
const markerBubble = document.getElementById("markerBubble");

function formatTime(sec) {
  if (isNaN(sec)) return "--:--";
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}

playBtn.addEventListener("click", () => {
  if (audioEl.paused) {
    audioEl.play();
    playBtn.textContent = "PAUSE";
  } else {
    audioEl.pause();
    playBtn.textContent = "PLAY";
  }
});

audioEl.addEventListener("loadedmetadata", () => {
  totalTimeEl.textContent = formatTime(audioEl.duration);
});

audioEl.addEventListener("timeupdate", () => {
  currentTimeEl.textContent = formatTime(audioEl.currentTime);
  if (!isNaN(audioEl.duration) && audioEl.duration > 0) {
    const pct = (audioEl.currentTime / audioEl.duration) * 100;
    progressFill.style.width = pct + "%";
  }
});

/* permitir clicar na barra pra pular no áudio */
progressBar.addEventListener("click", (e) => {
  const rect = progressBar.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const ratio = clickX / rect.width;
  if (!isNaN(audioEl.duration)) {
    audioEl.currentTime = ratio * audioEl.duration;
  }
});

/* =========================================================
   CHAT LOCAL + TIMECODE (Etapa 1)
   - guardamos mensagens no localStorage
   - cada msg tem {text, tAudio, at, nick}
   - desenhamos marcadores na barra
   ========================================================= */

const chatLogEl = document.getElementById("chatLog");
const chatInputEl = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

/* chave local */
const STORAGE_KEY = "lagostaChatMessages_v1";

/* carrega msgs do localStorage (fallback offline) */
function loadLocalMessages() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    return JSON.parse(raw);
  } catch(e) {
    return [];
  }
}

/* salva msgs localmente */
function saveLocalMessages(msgs) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(msgs));
  } catch(e) {}
}

/* renderiza chat */
function renderChat(msgs) {
  chatLogEl.innerHTML = "";
  msgs
    .sort((a,b)=>a.at - b.at) // ordena por data de envio
    .forEach(m => {
      const line = document.createElement("div");
      line.className = "chat-line";
      const hh = String(m.atHour).padStart(2,"0");
      const mm = String(m.atMin).padStart(2,"0");
      line.innerHTML = `
        <span class="hora">[${hh}:${mm}]</span>
        <span class="nick">${m.nick || "OUVINTE"}:</span>
        ${escapeHtml(m.text)}
        <span class="at-time">@${formatTime(m.tAudio)}</span>
      `;
      chatLogEl.appendChild(line);
    });

  chatLogEl.scrollTop = chatLogEl.scrollHeight;
}

/* limpa e redesenha marcadores na barra */
function renderMarkers(msgs) {
  // remove antigos
  const olds = progressBar.querySelectorAll(".comment-marker");
  olds.forEach(o => o.remove());

  // para cada msg, cria marcador posicionado de acordo com tAudio
  if (isNaN(audioEl.duration) || audioEl.duration === 0) return;

  msgs.forEach(m => {
    const pct = (m.tAudio / audioEl.duration) * 100;
    const marker = document.createElement("div");
    marker.className = "comment-marker";
    marker.style.left = `calc(${pct}% - 3px)`; // centraliza a barrinha

    // hover / toque mostra bolha
    marker.addEventListener("mouseenter", () => {
      showMarkerBubble(m, marker);
    });
    marker.addEventListener("mouseleave", () => {
      hideMarkerBubble();
    });
    marker.addEventListener("click", () => {
      // clicar pula o áudio pra esse ponto
      audioEl.currentTime = m.tAudio;
    });

    progressBar.appendChild(marker);
  });
}

function showMarkerBubble(msg, markerEl) {
  const rect = progressBar.getBoundingClientRect();
  const markerRect = markerEl.getBoundingClientRect();

  markerBubble.style.display = "block";
  markerBubble.textContent = `${formatTime(msg.tAudio)} — ${msg.text}`;
  const leftPos = markerRect.left - rect.left;
  markerBubble.style.left = leftPos + "px";
}

function hideMarkerBubble() {
  markerBubble.style.display = "none";
}

/* adicionar mensagem nova */
function addMessage(text) {
  if (!text.trim()) return;

  const now = new Date();
  const at = now.getTime();
  const atHour = now.getHours();
  const atMin = now.getMinutes();

  const tAudio = (!isNaN(audioEl.currentTime)) ? audioEl.currentTime : 0;

  const newMsg = {
    text: text.trim(),
    tAudio,
    at,
    atHour,
    atMin,
    nick: "VOCÊ"  // pode evoluir depois p/ nickname custom
  };

  // atualiza local cache
  messages.push(newMsg);
  saveLocalMessages(messages);

  // tenta mandar pro Firebase (Etapa 2)
  sendToFirebase(newMsg);

  // redesenha chat e marcadores
  renderChat(messages);
  renderMarkers(messages);
}

/* clique no botão ENVIAR */
sendBtn.addEventListener("click", () => {
  const v = chatInputEl.value;
  if (!v.trim()) return;
  addMessage(v);
  chatInputEl.value = "";
});

/* enter também envia */
chatInputEl.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    const v = chatInputEl.value;
    if (!v.trim()) return;
    addMessage(v);
    chatInputEl.value = "";
  }
});

/* sani text pra não injetar html */
function escapeHtml(str) {
  return str.replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[s]));
}

/* inicializa mensagens locais */
let messages = loadLocalMessages();

/* quando metadata do áudio carregar, podemos desenhar os marcadores */
audioEl.addEventListener("loadedmetadata", () => {
  renderChat(messages);
  renderMarkers(messages);
});
/* se usuário comenta antes do áudio carregar, markers virão depois */
renderChat(messages);

/* =========================================================
   Etapa 2: Firebase Realtime Database
   ---------------------------------------------------------
   O fluxo:
   - initFirebase() chamada no fim
   - sendToFirebase(msg) envia msg pro banco
   - onFirebaseMessage(cb) escuta novas msgs vindas do banco,
     atualiza 'messages' local e re-renderiza
   ========================================================= */

/* placeholders para Firebase SDK */
let firebaseApp = null;
let firebaseDb = null;
let firebaseEnabled = false;

/* envia pro Firebase */
function sendToFirebase(msg) {
  if (!firebaseEnabled || !firebaseDb) return;
  try {
    // push pro caminho "messages"
    const newKey = window.firebasePushKey();
    window.firebaseWriteMessage(msg, newKey);
  } catch(e) {
    // se falhar, tudo bem, segue local
  }
}

/* escuta Firebase em tempo real */
function startFirebaseListener() {
  if (!firebaseEnabled || !firebaseDb) return;
  window.firebaseOnMessage((incomingList) => {
    // incomingList deve ser array de msgs do banco
    // merge com local, evitando duplicar
    let changed = false;
    incomingList.forEach(m => {
      const exists = messages.some(
        x => x.at === m.at && x.text === m.text && Math.abs(x.tAudio - m.tAudio) < 0.01
      );
      if (!exists) {
        messages.push(m);
        changed = true;
      }
    });
    if (changed) {
      saveLocalMessages(messages);
      renderChat(messages);
      renderMarkers(messages);
    }
  });
}

/* inicializa Firebase */
function initFirebase() {
  try {
 const firebaseConfig = {
  apiKey: "AIzaSyD4tr7eZNSvs3z49ROibvM48mjEZLCImZo",
  authDomain: "lagosta-fm.firebaseapp.com",
  databaseURL: "https://lagosta-fm-default-rtdb.firebaseio.com",
  projectId: "lagosta-fm",
  storageBucket: "lagosta-fm.firebasestorage.app",
  messagingSenderId: "1037798589381",
  appId: "1:1037798589381:web:f9c6b5d7721746994881ac"
};

// inicializa Firebase (modo clássico)
window.firebaseInit = function(firebaseConfig) {
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  firebaseApp = app;
  firebaseDb = db;
};

// ativa Firebase e listener
window.firebaseInit(firebaseConfig);
firebaseEnabled = true;
startFirebaseListener();

  } catch(e) {
    firebaseEnabled = false;
  }
}

/* chama initFirebase pra preparar quando você colar sua config */
initFirebase();

/* =========================================================
   Mini "SDK" wrapper pro Firebase
   ---------------------------------------------------------
   A ideia aqui:
   - Você vai incluir os scripts do Firebase Web SDK abaixo
   - Depois vai ativar firebaseInit(firebaseConfig)
   - Isso habilita os helpers firebasePushKey, firebaseWriteMessage,
     firebaseOnMessage etc.
   ========================================================= */

/*
IMPORTANTE:
Quando você criar seu projeto no Firebase:
1. Ativa Realtime Database em modo teste.
2. Copia sua config (apiKey etc.) e cola no firebaseConfig acima.
3. Descomenta as funções abaixo e o script <script src="...firebase..."> que eu vou deixar preparado.
4. A partir daí, o chat é realmente ao vivo pra todo mundo.
*/

// window.firebaseInit = function(firebaseConfig) {
//   const app = firebase.initializeApp(firebaseConfig);
//   const db = firebase.database();
//   firebaseApp = app;
//   firebaseDb = db;
// };

// window.firebasePushKey = function() {
//   const ref = firebaseDb.ref("messages");
//   return ref.push().key;
// };

// window.firebaseWriteMessage = function(msg, key) {
//   const ref = firebaseDb.ref("messages/" + key);
//   ref.set(msg);
// };

// window.firebaseOnMessage = function(cb) {
//   const ref = firebaseDb.ref("messages");
//   ref.on("value", (snapshot) => {
//     const data = snapshot.val() || {};
//     // transforma em array
//     const list = Object.values(data);
//     cb(list);
//   });
// };

</script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>


</body>
</html>
